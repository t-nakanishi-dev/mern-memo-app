// server/index.js
const express = require("express");
const cors = require("cors");
const mongoose = require("mongoose");
const path = require("path"); // Node.jsæ¨™æº–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«: ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æ‰±ã†ãŸã‚ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
const memoRoutes = require("./routes/memos"); // ãƒ¡ãƒ¢é–¢é€£ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
const authRoutes = require("./routes/auth"); // èªè¨¼é–¢é€£ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
const userRoutes = require("./routes/users"); // ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
require("dotenv").config(); // ç’°å¢ƒå¤‰æ•°ã‚’ .env ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€

const app = express();
const PORT = process.env.PORT || 3000; // ç’°å¢ƒå¤‰æ•° PORT ãŒã‚ã‚Œã°å„ªå…ˆã—ã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§3000ç•ªã‚’åˆ©ç”¨

// ==========================
// MongoDBã¸ã®æŽ¥ç¶šå‡¦ç†
// ==========================
mongoose
  .connect(process.env.MONGODB_URI) // .env ã«å®šç¾©ã•ã‚ŒãŸ MongoDB ã®æŽ¥ç¶šURIã‚’ä½¿ç”¨
  .then(() => console.log("âœ… MongoDB Connected")) // æŽ¥ç¶šæˆåŠŸ
  .catch((err) => console.error("âŒ MongoDB Connection Error:", err)); // æŽ¥ç¶šå¤±æ•—

// ==========================
// ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®è¨­å®š
// ==========================
app.use(cors()); // CORSï¼ˆã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³ãƒªã‚½ãƒ¼ã‚¹ã‚·ã‚§ã‚¢ãƒªãƒ³ã‚°ï¼‰ã‚’è¨±å¯
app.use(express.json()); // JSONå½¢å¼ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’è‡ªå‹•ã§ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

// ==========================
// APIãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®è¨­å®š
// ==========================
app.use("/api/memos", memoRoutes); // /api/memos/... â†’ ãƒ¡ãƒ¢é–¢é€£ã®å‡¦ç†
app.use("/api/users", userRoutes); // /api/users/... â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«é–¢é€£ã®å‡¦ç†
app.use("/api", authRoutes); // /api/... â†’ èªè¨¼é–¢é€£ã®å‡¦ç†ï¼ˆä¾‹: /api/login, /api/registerï¼‰

// ==========================
// Reactã‚¢ãƒ—ãƒªã®ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ä¿¡
// ==========================
// Expressã§ client/build å†…ã®é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æä¾›ã™ã‚‹ã€‚
// ã“ã‚Œã«ã‚ˆã‚Šã€æœ¬ç•ªç’°å¢ƒã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’åŒä¸€ã‚µãƒ¼ãƒãƒ¼ã§å‹•ã‹ã›ã‚‹ã€‚
app.use(express.static(path.join(__dirname, "../client/build")));

// ==========================
// SPAï¼ˆã‚·ãƒ³ã‚°ãƒ«ãƒšãƒ¼ã‚¸ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ç”¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ«ãƒ¼ãƒˆ
// ==========================
// - /api ã§å§‹ã¾ã‚‰ãªã„ã™ã¹ã¦ã® GET ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã¦ index.html ã‚’è¿”å´
// - React Router ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒæ©Ÿèƒ½ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
// - ã“ã®å‡¦ç†ã¯ API ãƒ«ãƒ¼ãƒˆã‚ˆã‚Šå¾Œã«ç½®ãå¿…è¦ãŒã‚ã‚‹
app.get("*", (req, res) => {
  res.sendFile(path.join(__dirname, "../client/build", "index.html"));
});

// ==========================
// ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
// ==========================
app.listen(PORT, () => {
  console.log(`ðŸš€ Server running on port ${PORT}`);
});
